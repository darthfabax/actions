name: Terragrunt Plan Workflow

on:
  workflow_call:
    inputs:
      # === TERRAGRUNT DESTROY CONFIGURATION ===
      destroy_directory:
        description: 'Directory to destroy'
        required: true
        type: string
        default: 'aws/<environment>/<region>/resources/<resource>'
      deploy-approval-environment:
        type: string
        description: 'El entorno para la etapa de aprobaci√≥n (ej: develop, staging, production)'
        required: false
        default: 'aws-deploy'
      aws_region:
        description: 'AWS region for credentials'
        required: false
        type: string
        default: 'eu-north-1'

      # === TOOL VERSIONS ===
      tf_version:
        description: 'Terraform version'
        required: false
        type: string
        default: '1.10.3'
      tg_version:
        description: 'Terragrunt version'
        required: false
        type: string
        default: '0.69.11'

jobs:
    # ===========================================
    # 1. TERRAGRUNT PLAN
    # ===========================================
    terragrunt-plan:
      name: Terragrunt Plan
      runs-on: ubuntu-latest
      steps:

      # ===========================================
      # CHECKOUT
      # ===========================================
      - name: Checkout
        uses: actions/checkout@v4

      # ===========================================
      # SETUP TERRAFORM
      # ===========================================      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.tf_version }}

      # ===========================================
      # SETUP TERRAGRUNT
      # ===========================================      
      - name: Setup Terragrunt
        run: |
          sudo wget -q -O /bin/terragrunt "https://github.com/gruntwork-io/terragrunt/releases/download/v${{ inputs.tg_version }}/terragrunt_linux_amd64"
          sudo chmod +x /bin/terragrunt

      # ===========================================
      # CONFIGURE AWS CREDENTIALS
      # ===========================================      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ACTIONS_ROLE_ARN }} # Reemplaza con el ARN de tu rol
          aws-region: eu-north-1 # Reemplaza con tu regi√≥n de AWS
          role-session-name: github-actions-terragrunt-destroy
          
      - name: Verify AWS credentials
        run: |
          echo "::group::AWS Identity"
          aws sts get-caller-identity
          echo "::endgroup::"
        working-directory: .

      # ===========================================
      # TERRAGRUNT PLAN
      # ===========================================
      - name: Terragrunt Plan
        id: run-plan
        working-directory: ./${{ github.event.inputs.destroy_directory }}
        run: |
            echo "üî• Starting plan of: ${{ github.event.inputs.destroy_directory }}"
            terragrunt plan -destroy --terragrunt-non-interactive -input=false
            echo "üî• Starting plan of: ${{ github.event.inputs.destroy_directory }}"

    # ===========================================
    # 2. APPROVAL GATE
    # ===========================================
    approval:
      name: Manual Approval
      needs: [terragrunt-plan]
      runs-on: ubuntu-latest
      environment: ${{ inputs.deploy-approval-environment }}

      steps:
      - name: Successful Plan - Awaiting Approval
        run: echo "‚úÖ The reviewer has approved the plan."

    # ===========================================
    # 3. TERRAGRUNT DESTROY
    # ===========================================
    terragrunt-destroy:
      name: Terragrunt Destroy
      needs: approval
      runs-on: ubuntu-latest
      steps:
        # ===========================================
        # CHECKOUT
        # ===========================================
        - name: Checkout
          uses: actions/checkout@v4

        # ===========================================
        # SETUP TERRAFORM
        # ===========================================      
        - name: Setup Terraform
          uses: hashicorp/setup-terraform@v3
          with:
            terraform_version: ${{ inputs.tf_version }}

        # ===========================================
        # SETUP TERRAGRUNT
        # ===========================================      
        - name: Setup Terragrunt
          run: |
            sudo wget -q -O /bin/terragrunt "https://github.com/gruntwork-io/terragrunt/releases/download/v${{ inputs.tg_version }}/terragrunt_linux_amd64"
            sudo chmod +x /bin/terragrunt

        # ===========================================
        # CONFIGURE AWS CREDENTIALS
        # ===========================================      
        - name: Configure AWS Credentials
          uses: aws-actions/configure-aws-credentials@v4
          with:
            role-to-assume: ${{ secrets.AWS_ACTIONS_ROLE_ARN }} # Reemplaza con el ARN de tu rol
            aws-region: eu-north-1 # Reemplaza con tu regi√≥n de AWS
            role-session-name: github-actions-terragrunt-destroy
            
        - name: Verify AWS credentials
          run: |
            echo "::group::AWS Identity"
            aws sts get-caller-identity
            echo "::endgroup::"
          working-directory: .

        # ===========================================
        # TERRAGRUNT DESTROY
        # ===========================================
        - name: Terragrunt Destroy
          id : run-destroy
          working-directory: ./${{ github.event.inputs.destroy_directory }}
          run: |
            echo "üî• Starting destroy of: ${{ github.event.inputs.destroy_directory }}"
            terragrunt destroy --terragrunt-non-interactive -input=false -auto-approve
            echo "‚úÖ Destroy completed for: ${{ github.event.inputs.destroy_directory }}"

        # ===========================================
        # REMOVE CODE FROM REPOSITORY
        # ===========================================
        - name: Remove infrastructure code from repository
          if: steps.run-destroy.outcome == 'success'
          run: |
            git config --global user.name 'github-actions[bot]'
            git config --global user.email 'github-actions[bot]@users.noreply.github.com'
            
            echo "üóëÔ∏è Removing code: ${{ github.event.inputs.destroy_directory }}"
            git rm -r ${{ github.event.inputs.destroy_directory }}
            git commit -m "chore: Remove infrastructure code for ${{ github.event.inputs.destroy_directory }}"
            git push
            echo "‚úÖ Code removed from repository"
